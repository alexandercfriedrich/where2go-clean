# Slug Generation System - Fixed Duplicate Constraint Violations

## Issue
The system was experiencing duplicate key constraint violations when inserting events:
```
duplicate key value violates unique constraint "idx_events_slug_unique"
Key (slug)=(art-advent-am-karlsplatz-karlsplatz-2025-11-21) already exists.
```

## Root Cause
The system had **TWO different slug generation methods** operating independently:

### 1. TypeScript Method (`app/lib/slugGenerator.ts`)
```typescript
export function generateEventSlug(event: {
  title: string;
  venue?: string;
  date: string;
}): string {
  // Format: {title}-{venue}-{date}
  // Example: "jazz-night-blue-note-2025-12-01"
  // NO UUID SUFFIX
}
```

### 2. Database Trigger (`supabase/migrations/004_add_event_slug.sql`)
```sql
CREATE OR REPLACE FUNCTION generate_event_slug()
RETURNS TRIGGER AS $$
BEGIN
  -- Format: {title}-{venue}-{date}-{8-char-uuid}
  -- Example: "jazz-night-blue-note-2025-12-01-abc12345"
  -- INCLUDES UUID SUFFIX FOR UNIQUENESS
END;
$$ LANGUAGE plpgsql;
```

### The Conflict
1. **EventRepository** was generating slugs in TypeScript (without UUID)
2. Multiple events with same title/venue/date got **identical slugs**
3. Database has **unique constraint** on slug field: `idx_events_slug_unique`
4. When trying to insert/update, constraint was violated
5. Upsert used `onConflict: 'title,start_date_time,city'` - different from slug uniqueness

## Solution

### Changed: EventRepository.eventDataToDbInsert()
**Before:**
```typescript
// Generate slug for SEO-friendly URLs
const slug = generateEventSlug({
  title: event.title,
  venue: event.venue,
  date: event.date
});

return {
  // ...
  slug: slug,  // ❌ Could be duplicate
  // ...
};
```

**After:**
```typescript
// NOTE: Do NOT generate slug in TypeScript - let the database trigger handle it
// The database trigger (generate_event_slug) adds a UUID suffix for uniqueness
// This ensures all slugs are unique and prevents constraint violations
// Format: {title}-{venue}-{date}-{8-char-uuid-suffix}

return {
  // ...
  slug: null,  // ✅ Let DB trigger generate unique slug
  // ...
};
```

### Key Changes
1. **EventRepository sets slug to null** - Database trigger handles generation
2. **Removed import** of `generateEventSlug` from EventRepository
3. **TypeScript method kept** for UI components (fallback when event.slug not available)

## System Integrity

### Single Source of Truth for Database Slugs
- **All event slugs in database** are generated by the database trigger
- Format: `{title}-{venue}-{date}-{8-char-uuid}`
- Guaranteed unique through UUID suffix
- Enforced by `idx_events_slug_unique` constraint

### UI Component Usage
When UI components need to display event URLs:
```typescript
// In EventCard.tsx, schemaOrg.ts, etc.
const eventSlug = ev.slug || generateEventSlug({
  title: ev.title,
  venue: ev.venue,
  date: ev.date
});
```

This is correct because:
- If event has been saved to DB, `ev.slug` will have UUID suffix
- If event is new/unsaved, `generateEventSlug()` provides fallback
- Fallback won't match real DB slug (missing UUID), but that's okay for temporary URLs

## Benefits

### ✅ No More Duplicate Slug Violations
```
// Before: Multiple events could have same slug
Event 1: "christmas-market-rathausplatz-2025-12-15" ❌
Event 2: "christmas-market-rathausplatz-2025-12-15" ❌ DUPLICATE!

// After: Each event gets unique slug from database
Event 1: "christmas-market-rathausplatz-2025-12-15-abc12345" ✅
Event 2: "christmas-market-rathausplatz-2025-12-15-def67890" ✅ UNIQUE!
```

### ✅ Consistency
- Only ONE method generates permanent slugs (database trigger)
- All slugs follow same format
- No divergence between TypeScript and SQL

### ✅ Reliability
- Database trigger runs automatically on INSERT/UPDATE
- Cannot be bypassed or forgotten
- UUID suffix ensures uniqueness even for identical events

## Testing
Added comprehensive test suite: `app/lib/__tests__/slug-integrity.test.ts`

Tests document:
- Two slug generation methods and their purposes
- Why EventRepository doesn't generate slugs
- How to verify slug consistency across system
- How duplicate violations are prevented

All tests passing ✅

## Migration Path

### No Action Required
- Change is backward compatible
- Existing events keep their slugs
- New events get proper unique slugs
- Database trigger already exists (migration 004)

### For Future Development
When working with event slugs:
1. **In EventRepository**: Always set `slug: null`
2. **In UI Components**: Use `event.slug || generateEventSlug(event)` pattern
3. **In Tests**: Use `event.slug = null` for new events
4. **In Database**: Trust the trigger to generate unique slugs

## Related Files

### Modified
- `app/lib/repositories/EventRepository.ts` - Removed slug generation

### Unchanged (Still Used)
- `app/lib/slugGenerator.ts` - Used by UI components
- `supabase/migrations/004_add_event_slug.sql` - Database trigger
- `app/components/EventCard.tsx` - Uses slug fallback
- `app/components/discovery/EventCard.tsx` - Uses slug fallback
- `app/lib/schemaOrg.ts` - Uses slug fallback

### New
- `app/lib/__tests__/slug-integrity.test.ts` - Documentation tests

## Verification

Run tests to verify fix:
```bash
npm test -- slug-integrity
npm test -- eventRepository
```

All tests should pass ✅

---

**Fixed by**: GitHub Copilot  
**Date**: 2025-11-21  
**Commits**: 8420717 (fix), f7b58fa (documentation)
