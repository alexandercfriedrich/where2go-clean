# Blog Article Daily Automation - Make.com Integration

## Overview

This system automatically triggers blog article generation for all Vienna event categories daily at 6 AM UTC via Make.com integration.

## Architecture

### Components

1. **Vercel Cron Job** (`/api/cron/generate-blog-articles`)
   - Runs daily at 6 AM UTC
   - Iterates through all 12 event categories
   - Triggers Make.com webhook for each category

2. **Make.com Webhook**
   - Receives category/city data from cron job
   - Orchestrates AI content generation (Claude, GPT-4, etc.)
   - Posts generated articles back to `/api/admin/blog-articles`

3. **Blog Articles API** (`/api/admin/blog-articles`)
   - Receives and stores generated articles
   - Supports INTERNAL_API_SECRET authentication for automated workflows

## Cron Schedule

```json
{
  "path": "/api/cron/generate-blog-articles",
  "schedule": "15 6 * * *"
}
```

**Schedule**: Daily at 6:15 AM UTC (7:15 AM CET / 8:15 AM CEST)
**Note**: Runs 15 minutes after cache-warmup to avoid resource conflicts and ensure cache is populated

## Environment Variables

### Required

```env
# Make.com Integration
MAKE_COM_WEBHOOK_URL=https://hook.eu1.make.com/your-webhook-id

# Vercel Cron Authentication
CRON_SECRET=your_cron_secret_here

# Blog Articles API Authentication (for Make.com to post back)
INTERNAL_API_SECRET=your_internal_api_secret

# Optional: Cities to generate articles for (comma-separated, defaults to "wien")
BLOG_GENERATION_CITIES=wien,berlin,linz
```

### Optional

```env
# Admin credentials (for manual management)
ADMIN_USER=your_admin_username
ADMIN_PASS=your_secure_password
```

## Make.com Scenario Setup

### Webhook Trigger

Your Make.com scenario should start with a **Custom Webhook** module that receives:

```json
{
  "city": "wien",
  "category": "Live-Konzerte",
  "timestamp": "2024-12-10T06:00:00.000Z",
  "source": "vercel-cron"
}
```

### Example Make.com Workflow

```
1. Webhook Trigger (receive city + category)
   â†“
2. OpenAI/Claude Module (generate article content)
   - Prompt: "Write a blog article about {category} events in {city}"
   - Include SEO optimization
   â†“
3. HTTP Request (post to blog articles API)
   - URL: https://your-domain.com/api/admin/blog-articles
   - Method: POST
   - Headers:
     * Content-Type: application/json
     * X-API-Secret: {{INTERNAL_API_SECRET}}
   - Body:
     {
       "city": "{{city}}",
       "category": "{{category}}",
       "title": "{{ai_generated_title}}",
       "content": "{{ai_generated_html}}",
       "meta_description": "{{ai_generated_description}}",
       "seo_keywords": "{{ai_generated_keywords}}"
     }
   â†“
4. Response Handler (log success/failure)
```

### Getting Your Make.com Webhook URL

1. Log into [Make.com](https://www.make.com)
2. Create a new scenario
3. Add a **Webhooks > Custom webhook** module
4. Click "Add" to create a new webhook
5. Copy the webhook URL (format: `https://hook.eu1.make.com/xxxxx`)
6. Add it to your `.env.local` as `MAKE_COM_WEBHOOK_URL`

## Vienna Event Categories

The cron job triggers article generation for all 12 categories:

1. **Clubs & Nachtleben** - Electronic music, DJs, parties
2. **Live-Konzerte** - Rock, pop, jazz, world music
3. **Klassik & Oper** - Classical concerts, opera
4. **Theater & Comedy** - Musicals, theater, comedy shows
5. **Museen & Ausstellungen** - Museums, galleries, exhibitions
6. **Film & Kino** - Movies, cinema, screenings
7. **Open Air & Festivals** - Outdoor events, festivals
8. **Kulinarik & MÃ¤rkte** - Food events, markets
9. **Sport & Fitness** - Sports, fitness activities
10. **Bildung & Workshops** - Educational events, workshops
11. **Familie & Kinder** - Family and children's events
12. **LGBTQ+** - Pride events, queer community

## Manual Testing

### Test Cron Job Locally

```bash
# Set environment variables in .env.local
CRON_SECRET=test_secret_123
MAKE_COM_WEBHOOK_URL=https://your-webhook-url.make.com

# Start development server
npm run dev

# Trigger cron job manually (in another terminal)
curl -X GET http://localhost:3000/api/cron/generate-blog-articles \
  -H "Authorization: Bearer test_secret_123"
```

### Expected Response

```json
{
  "success": true,
  "city": "wien",
  "totalCategories": 12,
  "successCount": 12,
  "failureCount": 0,
  "timestamp": "2024-12-10T06:00:00.000Z",
  "results": [
    {
      "category": "Clubs & Nachtleben",
      "success": true
    },
    // ... all 12 categories
  ]
}
```

## Deployment Checklist

- [ ] Set `MAKE_COM_WEBHOOK_URL` in Vercel project settings
- [ ] Set `CRON_SECRET` in Vercel project settings (auto-generated by Vercel)
- [ ] Set `INTERNAL_API_SECRET` in Vercel project settings
- [ ] Deploy to production
- [ ] Verify cron job is listed in Vercel Dashboard > Cron Jobs
- [ ] Set up Make.com scenario
- [ ] Test Make.com webhook manually
- [ ] Wait for next 6 AM UTC run or trigger manually via Vercel dashboard

## Monitoring & Logs

### Vercel Logs

View cron job execution logs in Vercel Dashboard:
1. Go to your project
2. Click "Logs" tab
3. Filter by function: `api/cron/generate-blog-articles`

### Make.com Logs

View webhook execution logs in Make.com:
1. Go to your scenario
2. Click "History" tab
3. View execution details for each trigger

### Blog Articles Dashboard

Monitor generated articles:
1. Visit `https://your-domain.com/admin/blog-articles`
2. Filter by status: "draft" to review new articles
3. Publish articles after review

## Troubleshooting

### Cron job not running

**Check**:
- Cron job is properly configured in `vercel.json`
- `CRON_SECRET` is set in Vercel environment variables
- Check Vercel dashboard for cron job execution status

**Solution**: Redeploy the project to ensure cron configuration is applied

### Make.com not receiving webhooks

**Check**:
- `MAKE_COM_WEBHOOK_URL` is correct
- Webhook URL is active in Make.com
- Check Make.com scenario history for incoming requests

**Solution**: Test webhook manually with curl:

```bash
curl -X POST https://your-webhook-url.make.com \
  -H "Content-Type: application/json" \
  -d '{"city":"wien","category":"Live-Konzerte","timestamp":"2024-12-10T06:00:00Z","source":"manual-test"}'
```

### Articles not being created

**Check**:
- Make.com scenario is actively running (not paused)
- `INTERNAL_API_SECRET` matches between Vercel and Make.com
- Blog articles API is working (test manually)
- Check Make.com logs for HTTP response errors

**Solution**: Test API endpoint manually:

```bash
curl -X POST https://your-domain.com/api/admin/blog-articles \
  -H "X-API-Secret: your_secret_here" \
  -H "Content-Type: application/json" \
  -d '{
    "city": "wien",
    "category": "Live-Konzerte",
    "title": "Test Article",
    "content": "<p>Test content</p>",
    "meta_description": "Test description"
  }'
```

### Too many API calls to AI service

**Problem**: 12 categories Ã— daily = potential cost concerns

**Solutions**:
1. **Batch processing**: Modify Make.com scenario to generate multiple categories in one AI call
2. **Selective generation**: Only generate articles for specific categories (modify cron job)
3. **Weekly schedule**: Change cron schedule to weekly instead of daily
4. **Rotate categories**: Generate different categories on different days

**Example - Selective Categories** (modify `route.ts`):

```typescript
// Only generate for specific high-priority categories
const categoriesToGenerate = [
  'Live-Konzerte',
  'Clubs & Nachtleben',
  'Theater & Comedy',
  'Museen & Ausstellungen'
];

for (const category of categoriesToGenerate) {
  // ... trigger webhook
}
```

**Example - Rotate by Day** (modify `route.ts`):

```typescript
// Generate different categories on different days of week
const dayOfWeek = new Date().getDay(); // 0 = Sunday, 6 = Saturday
const categoriesPerDay = Math.ceil(EVENT_CATEGORIES.length / 7);
const startIndex = dayOfWeek * categoriesPerDay;
const endIndex = startIndex + categoriesPerDay;
const todaysCategories = EVENT_CATEGORIES.slice(startIndex, endIndex);

for (const category of todaysCategories) {
  // ... trigger webhook
}
```

## Cost Optimization

### AI Service Costs

- **OpenAI GPT-4**: ~$0.03 per article (1K tokens)
- **Claude 3.5 Sonnet**: ~$0.015 per article (1K tokens)
- **Daily cost**: 12 articles Ã— $0.015 = ~$0.18/day = ~$5.40/month

### Recommendations

1. **Use cheaper models** for draft generation (GPT-3.5, Claude Haiku)
2. **Review before publishing** - generate as drafts, publish manually
3. **Schedule strategically** - generate only when events are updated
4. **Reuse templates** - create reusable article structures

## Advanced Configuration

### Multiple Cities

To support multiple cities, modify the cron job:

```typescript
const cities = ['wien', 'berlin', 'linz'];

for (const city of cities) {
  for (const category of EVENT_CATEGORIES) {
    // ... trigger webhook with city and category
  }
}
```

### Custom Schedules

Different categories at different times:

```typescript
// Morning: Family-friendly content
if (new Date().getHours() === 6) {
  triggerCategories(['Familie & Kinder', 'Museen & Ausstellungen']);
}

// Evening: Nightlife content
if (new Date().getHours() === 18) {
  triggerCategories(['Clubs & Nachtleben', 'Live-Konzerte']);
}
```

### Conditional Generation

Only generate if new events are available:

```typescript
// Check if new events exist for category
const hasNewEvents = await checkNewEventsForCategory(city, category);
if (hasNewEvents) {
  // Trigger webhook
}
```

## Security Considerations

### Secrets Management

- **Never commit secrets** to git
- Use Vercel environment variables for production
- Use `.env.local` for local development (not committed)
- Rotate secrets regularly

### Webhook Security

- Make.com webhooks are public URLs
- Consider adding signature verification
- Monitor webhook logs for suspicious activity
- Rate limit webhook endpoints if needed

### API Authentication

- `INTERNAL_API_SECRET` should be strong (min 32 characters)
- Different from admin credentials
- Rotate periodically
- Monitor API usage

## Related Documentation

- [Quick Reference Card](./docs/QUICK_REFERENCE.md) - âš¡ Fast setup guide and cheat sheet
- [Make.com Scenario Example](./docs/make-com-scenario-example.md) - ðŸ“– Detailed step-by-step Make.com setup
- [Blog Articles Implementation](./BLOG_ARTICLES_IMPLEMENTATION.md) - Full API documentation
- [Blog Articles Quickstart](./BLOG_ARTICLES_QUICKSTART.md) - Quick setup guide
- [Security Summary](./SECURITY_SUMMARY_BLOG_ARTICLES.md) - Security details

## Support

For issues or questions:
1. Check [Quick Reference Card](./docs/QUICK_REFERENCE.md) for common solutions
2. Review [Make.com Scenario Example](./docs/make-com-scenario-example.md) for detailed setup
3. Check Vercel logs for cron execution errors
4. Check Make.com logs for webhook processing
5. Test API endpoints manually with curl
6. Review troubleshooting section in this documentation
7. Check environment variables are set correctly
