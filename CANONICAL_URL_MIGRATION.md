# Canonical URL Migration - Implementation Summary

## Changes Made

### 1. Updated Canonical URL Format (app/lib/schemaOrg.ts)

**Old Format:**
```
/event/{city}/{date}/{title-slug}
```

**New Format:**
```
/{city}/event/{date}/{title-slug}
```

This change makes canonical URLs consistent with the app's city-first routing pattern used throughout the application (e.g., `/wien/heute`, `/berlin/morgen`).

#### Key Improvements:
- Added NFKD normalization for proper diacritics handling (é→e, ü→u, etc.)
- Robust fallback chain: `city` → `venue` → `'event'`
- Consistent slugification for both city and title
- Date always normalized to YYYY-MM-DD format (first 10 chars)

#### Example Transformations:
- "Fête de la Musique" → "fete-de-la-musique"
- "München" → "munchen"
- "Rock & Roll!!!" → "rock-roll"

### 2. Added Legacy Event Route (app/event/[...params]/page.tsx)

A new fallback route handles old URLs to prevent 404 errors for external links.

#### URL Pattern Handled:
```
/event/{cityOrVenue}/{date}/{title-slug...}
```

#### Lookup Strategy:
1. Try to resolve city using `resolveCityFromParam()`
2. Load events from day-bucket cache via `getDayEvents()`
3. Fallback to per-category cache via `eventsCache.getEventsByCategories()`
4. Match event by canonical URL or title slug comparison
5. Filter expired events using `isEventValidNow()`

#### Behavior:
- **Event Found:** Display minimal event detail page with:
  - Notice about legacy URL with link to canonical URL
  - Full event details with Schema.org microdata
  - Link back to city day listing
  
- **Event Not Found (City Resolved):** Redirect to `/{city-slug}/{date}`
- **Event Not Found (City Unknown):** Return 404

#### Features:
- Fully server-rendered (Next.js 14 App Router)
- Dynamic route marked with `export const dynamic = 'force-dynamic'`
- Uses existing helpers for consistency
- Includes helpful console.log statements for debugging

### 3. Test Coverage

#### Updated Tests (app/lib/__tests__/schemaOrg.test.ts)
- All 25 tests passing
- Updated expected URLs to match new city-first format
- Added diacritics normalization test

#### New Tests (app/lib/__tests__/canonicalUrl.test.ts)
- 11 comprehensive tests covering:
  - New city-first routing pattern
  - Next.js dynamic route compatibility
  - Complex titles with special characters
  - Fallback scenarios
  - Legacy URL compatibility
  - Edge cases (spaces, hyphens, dates)

**Total: 36 tests passing**

## Migration Path

### For Existing URLs:
Old URLs like `/event/wien/2025-01-20/rock-concert` will:
1. Hit the new `/event/[...params]` route
2. Resolve "wien" as city
3. Load day-bucket for 2025-01-20
4. Find event by matching title slug
5. Display event page with notice about legacy URL
6. Provide canonical link: `/wien/event/2025-01-20/rock-concert`

### For New URLs:
New canonical URLs generated by `generateCanonicalUrl()` will follow the pattern:
```
/{city}/event/{date}/{title-slug}
```

This matches the existing city page pattern and can be enhanced in future with proper event detail pages at `/{city}/event/{date}/{title-slug}`.

## Compatibility

### Existing Code:
✅ No breaking changes to existing pages
✅ All components using `generateCanonicalUrl()` automatically get new format
✅ All tests updated and passing
✅ Build successful
✅ Linting clean
✅ CodeQL security check: 0 vulnerabilities

### Data Consistency:
- Event matching uses same normalization logic as deduplication
- Canonical URLs are deterministic and stable
- City resolution uses same helper as main app routing

## Security

- **CodeQL Check:** ✅ 0 vulnerabilities found
- **Input Validation:** Date format validated with regex
- **XSS Protection:** All user data properly escaped in JSX
- **No SQL Injection:** Uses Redis key-value lookups only
- **Safe Redirects:** Only internal redirects to app routes

## Performance

- **Minimal Overhead:** Uses existing cache infrastructure
- **No Extra API Calls:** Direct cache access like existing pages
- **Efficient Lookups:** Day-bucket first, per-category fallback
- **Server-Side Only:** No client-side JavaScript for routing logic

## Maintenance Notes

### If You Need To:

**Change URL format again:**
- Update `generateCanonicalUrl()` in `app/lib/schemaOrg.ts`
- Update tests in `app/lib/__tests__/schemaOrg.test.ts`
- Add new legacy route if needed

**Add event detail pages:**
- Create `app/[city]/event/[date]/[title]/page.tsx`
- Keep legacy route for backward compatibility
- Consider 301 redirect from legacy route to canonical URL

**Modify event matching logic:**
- Update `findEventInList()` in `app/event/[...params]/page.tsx`
- Add tests to `app/lib/__tests__/canonicalUrl.test.ts`

## Related Files

### Modified:
- `app/lib/schemaOrg.ts` - Updated canonical URL generation
- `app/lib/__tests__/schemaOrg.test.ts` - Updated tests

### Created:
- `app/event/[...params]/page.tsx` - Legacy URL fallback route
- `app/lib/__tests__/canonicalUrl.test.ts` - New comprehensive tests
- `CANONICAL_URL_MIGRATION.md` - This documentation

### Dependencies:
- `app/lib/city.ts` - resolveCityFromParam, formatGermanDate
- `app/lib/dayCache.ts` - getDayEvents, isEventValidNow
- `app/lib/cache.ts` - eventsCache.getEventsByCategories
- `app/lib/aggregator.ts` - eventAggregator.deduplicateEvents
- `app/lib/eventCategories.ts` - EVENT_CATEGORIES
- `app/components/SchemaOrg.tsx` - JSON-LD rendering
- `app/lib/types.ts` - EventData interface

## Questions?

Contact the maintainer or check:
- Next.js 14 App Router docs
- Schema.org Event specification
- Redis caching documentation in HYBRID_CACHE_COMPLETE.md
